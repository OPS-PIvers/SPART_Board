import { WidgetType, GradeLevel, GradeFilter } from '../types';

export const ALL_GRADE_LEVELS: GradeLevel[] = ['k-2', '3-5', '6-8', '9-12'];

/**
 * WIDGET GRADE LEVEL CONFIGURATION
 *
 * This file defines which grade levels each widget is intended for.
 * Teachers will be able to filter widgets by grade level in the sidebar.
 *
 * Grade Levels:
 * - 'k-2': Kindergarten through 2nd grade
 * - '3-5': 3rd through 5th grade
 * - '6-8': 6th through 8th grade (middle school)
 * - '9-12': 9th through 12th grade (high school)
 *
 * Instructions:
 * - To change a widget's grade levels, simply edit the array for that widget
 * - A widget can have multiple grade levels: ['k-2', '3-5'] means it shows in both filters
 * - Each grade level will be displayed as a separate chip in the UI
 * - Use ALL_GRADE_LEVELS for widgets appropriate for all grades
 */
export const WIDGET_GRADE_LEVELS: Record<WidgetType, GradeLevel[]> = {
  // Clock & Time Tools
  clock: ALL_GRADE_LEVELS,
  'time-tool': ALL_GRADE_LEVELS,

  // Classroom Management
  traffic: ['k-2', '3-5'],
  workSymbols: ALL_GRADE_LEVELS,
  sound: ALL_GRADE_LEVELS,

  // Content & Communication
  text: ALL_GRADE_LEVELS,
  checklist: ALL_GRADE_LEVELS,
  qr: ['6-8', '9-12'],

  // Random & Fun
  random: ALL_GRADE_LEVELS,
  dice: ['k-2', '3-5'],

  // Creative Tools
  drawing: ['k-2', '3-5'],
  webcam: ALL_GRADE_LEVELS,

  // Academic Tools
  poll: ['6-8', '9-12'],
  scoreboard: ALL_GRADE_LEVELS,
  embed: ['6-8', '9-12'],

  // Planning & Organization
  schedule: ALL_GRADE_LEVELS,
  calendar: ALL_GRADE_LEVELS,
  weather: ALL_GRADE_LEVELS,
  lunchCount: ['k-2', '3-5'],
  classes: ALL_GRADE_LEVELS,
  instructionalRoutines: ALL_GRADE_LEVELS,
  miniApp: ALL_GRADE_LEVELS,
  materials: ALL_GRADE_LEVELS,
  stickers: ALL_GRADE_LEVELS,
  sticker: [],
  'seating-chart': ALL_GRADE_LEVELS,
};

/**
 * Helper function to get grade levels for a specific widget type
 */
export function getWidgetGradeLevels(widgetType: WidgetType): GradeLevel[] {
  const levels = WIDGET_GRADE_LEVELS[widgetType];

  // Development-mode warning for missing widget configuration
  if (!levels && process.env.NODE_ENV === 'development') {
    console.warn(
      `Widget "${widgetType}" is missing from WIDGET_GRADE_LEVELS configuration. Defaulting to ALL_GRADE_LEVELS.`
    );
  }

  // Gracefully handle migration by filtering out any "universal" strings if they persist in data/cache
  const safeLevels = (levels || ALL_GRADE_LEVELS).filter(
    (l) => l !== ('universal' as string)
  );

  // If filtered result is empty (was only universal) or was missing, default to all
  if (safeLevels.length === 0) return ALL_GRADE_LEVELS;

  return safeLevels;
}

/**
 * Helper function to check if a widget matches a grade level filter
 *
 * Filter behavior:
 * - 'all': Shows all widgets
 * - 'k-2': Shows widgets tagged with 'k-2'
 * - '3-5': Shows widgets tagged with '3-5'
 * - '6-8': Shows widgets tagged with '6-8'
 * - '9-12': Shows widgets tagged with '9-12'
 */
export function widgetMatchesGradeFilter(
  widgetType: WidgetType,
  filter: GradeFilter
): boolean {
  if (filter === 'all') return true;

  const levels = getWidgetGradeLevels(widgetType);

  // Direct match check (since universal is gone, we just check inclusion)
  return levels.includes(filter);
}
