rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if user is an admin
    function isAdmin() {
      return request.auth != null &&
             request.auth.token.email != null &&
             exists(/databases/$(database)/documents/admins/$(request.auth.token.email.lower()));
    }

    // Admins collection
    match /admins/{email} {
      // Users can read their own admin record to check status
      // We use lower() to ensure case-insensitive matching
      allow read: if request.auth != null && 
                  request.auth.token.email != null && 
                  request.auth.token.email.lower() == email.lower();
      allow write: if false; // Only create via Firebase Console or Admin SDK
    }

    // Dashboards - users can only access their own dashboards in their subcollection
    match /users/{userId}/dashboards/{dashboardId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // Rosters - users can only access their own rosters in their subcollection
    match /users/{userId}/rosters/{rosterId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // User data collection
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // Admin-only collections
    match /admin_settings/{document=**} {
      allow read, write: if isAdmin();
    }

    // Feature permissions - all authenticated users can read, only admins can write
    match /feature_permissions/{widgetType} {
      allow read: if request.auth != null;
      allow write: if isAdmin();
    }

    // Global permissions - all authenticated users can read, only admins can write
    match /global_permissions/{featureId=**} {
      allow read: if request.auth != null;
      allow write: if isAdmin();
    }

    // Admin backgrounds - authenticated users can read based on access level, only admins can write
    match /admin_backgrounds/{backgroundId} {
      // Admins can read everything
      allow read: if isAdmin();
      
      // Non-admins can read public backgrounds
      allow read: if request.auth != null && resource.data.accessLevel == 'public';
      
      // Non-admins can read beta backgrounds if they are explicitly in the beta list
      allow read: if request.auth != null && 
                  resource.data.accessLevel == 'beta' && 
                  request.auth.token.email.lower() in resource.data.betaUsers;

      allow write: if isAdmin();
    }

    // Global weather data
    match /global_weather/{document=**} {
      allow read: if request.auth != null;
      allow write: if isAdmin();
    }

    // Instructional routines - all authenticated users can read, only admins can write
    match /instructional_routines/{routineId} {
      allow read: if request.auth != null;
      allow write: if isAdmin();
    }

    // Shared boards - Anyone can read, only authenticated users can create. 
    // Authors and admins can update or delete.
    match /shared_boards/{shareId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null &&
        request.resource.data.originalAuthor == request.auth.uid;
      allow update, delete: if request.auth != null &&
        (resource.data.get('originalAuthor', null) == request.auth.uid || isAdmin());
    }

    // Sessions - Teacher owns it, Students can join
    match /sessions/{userId} {
      // Only authenticated users (including anonymous) can read sessions
      // This allows students to find sessions by code and listen to updates
      // TODO: For Phase 2/Production, implement Cloud Functions to validate
      // join codes server-side and remove this broad read permission.
      allow read: if request.auth != null;
      allow write: if request.auth != null && request.auth.uid == userId; // Teacher controls it
      
      match /students/{studentId} {
        // Student session records access:
        // - Teacher (session owner) can read/write all student records
        // - Students can create their own record (with authUid matching their auth.uid)
        // - Students can read their own record (where authUid matches their auth.uid)
        // - Admins have full access
        allow read: if request.auth != null &&
          (request.auth.uid == userId ||
           resource.data.authUid == request.auth.uid ||
           isAdmin());
        allow create: if request.auth != null &&
          (request.auth.uid == userId ||
           request.resource.data.authUid == request.auth.uid ||
           isAdmin());
        allow update, delete: if request.auth != null &&
          (request.auth.uid == userId ||
           isAdmin());
      }
    }

    // Default deny all other collections
    match /{document=**} {
      allow read, write: if false;
    }
  }
}