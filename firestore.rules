rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if user is an admin
    function isAdmin() {
      return request.auth != null &&
             request.auth.token.email != null &&
             exists(/databases/$(database)/documents/admins/$(request.auth.token.email.lower()));
    }

    // Admins collection
    match /admins/{email} {
      // Users can read their own admin record to check status
      // We use lower() to ensure case-insensitive matching
      allow read: if request.auth != null && 
                  request.auth.token.email != null && 
                  request.auth.token.email.lower() == email.lower();
      allow write: if false; // Only create via Firebase Console or Admin SDK
    }

    // Dashboards - users can only access their own dashboards in their subcollection
    match /users/{userId}/dashboards/{dashboardId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
      // SECURITY NOTE: Weather widget proxyUrl changes should ideally be restricted to admins
      // via server-side validation. Currently, this is only enforced client-side (UI disabled
      // + onChange guard). For production deployments requiring strict SSRF protection,
      // implement custom validation logic to check widget configs or use Cloud Functions
      // to enforce proxy URL restrictions.
    }

    // User data collection
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // Admin-only collections
    match /admin_settings/{document=**} {
      allow read, write: if isAdmin();
    }

    // Feature permissions - all authenticated users can read, only admins can write
    match /feature_permissions/{widgetType} {
      allow read: if request.auth != null;
      allow write: if isAdmin();
    }

    // Admin backgrounds - authenticated users can read based on access level, only admins can write
    match /admin_backgrounds/{backgroundId} {
      // Admins can read everything
      allow read: if isAdmin();
      
      // Non-admins can read public backgrounds
      allow read: if request.auth != null && resource.data.accessLevel == 'public';
      
      // Non-admins can read beta backgrounds if they are explicitly in the beta list
      allow read: if request.auth != null && 
                  resource.data.accessLevel == 'beta' && 
                  request.auth.token.email.lower() in resource.data.betaUsers;

      allow write: if isAdmin();
    }

    // Default deny all other collections
    match /{document=**} {
      allow read, write: if false;
    }
  }
}