rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if user is an admin
    function isAdmin() {
      return request.auth != null &&
             request.auth.token.email != null &&
             exists(/databases/$(database)/documents/admins/$(request.auth.token.email.lower()));
    }

    // Admins collection
    match /admins/{email} {
      // Users can read their own admin record to check status
      // We use lower() to ensure case-insensitive matching
      allow read: if request.auth != null && 
                  request.auth.token.email != null && 
                  request.auth.token.email.lower() == email.lower();
      allow write: if false; // Only create via Firebase Console or Admin SDK
    }

    // Dashboards - users can only access their own dashboards in their subcollection
    match /users/{userId}/dashboards/{dashboardId} {
      // All authenticated users can read their own dashboards
      allow read: if request.auth != null && request.auth.uid == userId;

      // Writes require additional validation for security-sensitive fields
      // Admin users have full write access, including widgets/proxyUrl
      // Non-admin users are completely restricted from writing widgets field to prevent
      // SSRF attacks via attacker-controlled proxyUrl values
      // NOTE: This is intentionally strict. Non-admins cannot modify widgets at all.
      // For more granular control allowing non-admins to modify certain widget properties
      // while protecting proxyUrl, implement Cloud Functions with beforeWrite triggers
      // to validate specific field changes in widget configs.
      allow write: if request.auth != null &&
                   request.auth.uid == userId &&
                   (
                     // Admins can freely modify dashboards, including widgets/proxyUrl
                     isAdmin() ||
                     // Non-admins: completely disallow writes that include a widgets field
                     // to prevent attacker-controlled proxyUrl values from being persisted.
                     !('widgets' in request.resource.data)
                   );
    }

    // User data collection
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // Admin-only collections
    match /admin_settings/{document=**} {
      allow read, write: if isAdmin();
    }

    // Feature permissions - all authenticated users can read, only admins can write
    match /feature_permissions/{widgetType} {
      allow read: if request.auth != null;
      allow write: if isAdmin();
    }

    // Admin backgrounds - authenticated users can read based on access level, only admins can write
    match /admin_backgrounds/{backgroundId} {
      // Admins can read everything
      allow read: if isAdmin();
      
      // Non-admins can read public backgrounds
      allow read: if request.auth != null && resource.data.accessLevel == 'public';
      
      // Non-admins can read beta backgrounds if they are explicitly in the beta list
      allow read: if request.auth != null && 
                  resource.data.accessLevel == 'beta' && 
                  request.auth.token.email.lower() in resource.data.betaUsers;

      allow write: if isAdmin();
    }

    // Default deny all other collections
    match /{document=**} {
      allow read, write: if false;
    }
  }
}