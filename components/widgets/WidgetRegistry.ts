/**
 * Widget Registry
 *
 * This file serves as the central directory for all widgets in the application.
 * It maps widget types (enums) to their respective React components for both
 * the main widget view and the settings panel.
 */

import React, { lazy } from 'react';
import {
  WidgetData,
  WidgetType,
  ScalingConfig,
  WidgetComponentProps,
} from '@/types';

// Component type definitions to ensure type safety
type SettingsComponentProps = {
  widget: WidgetData;
};

type WidgetComponent =
  | React.ComponentType<WidgetComponentProps>
  | React.LazyExoticComponent<React.ComponentType<WidgetComponentProps>>;
type SettingsComponent =
  | React.ComponentType<SettingsComponentProps>
  | React.LazyExoticComponent<React.ComponentType<SettingsComponentProps>>;

// Lazy load helper for named exports
const lazyNamed = (
  importFactory: () => Promise<Record<string, unknown>>,
  name: string
) => {
  return lazy(() =>
    importFactory().then((module) => ({
      default: module[name] as React.ComponentType<unknown>,
    }))
  );
};

// Fallback Settings (lazy loading for consistency)
const DefaultSettings = lazyNamed(
  () => import('./FallbackSettings'),
  'DefaultSettings'
);
const MiniAppSettings = lazyNamed(
  () => import('./FallbackSettings'),
  'MiniAppSettings'
);

export const WIDGET_COMPONENTS: Partial<Record<WidgetType, WidgetComponent>> = {
  clock: lazyNamed(() => import('./ClockWidget'), 'ClockWidget'),
  'time-tool': lazyNamed(
    () => import('./TimeTool/TimeToolWidget'),
    'TimeToolWidget'
  ),
  traffic: lazyNamed(
    () => import('./TrafficLightWidget'),
    'TrafficLightWidget'
  ),
  text: lazyNamed(() => import('./TextWidget'), 'TextWidget'),
  checklist: lazyNamed(() => import('./ChecklistWidget'), 'ChecklistWidget'),
  random: lazyNamed(() => import('./random/RandomWidget'), 'RandomWidget'),
  dice: lazyNamed(() => import('./DiceWidget'), 'DiceWidget'),
  sound: lazyNamed(() => import('./SoundWidget'), 'SoundWidget'),
  webcam: lazyNamed(() => import('./WebcamWidget'), 'WebcamWidget'),
  embed: lazyNamed(() => import('./EmbedWidget'), 'EmbedWidget'),
  drawing: lazyNamed(() => import('./DrawingWidget'), 'DrawingWidget'),
  qr: lazyNamed(() => import('./QRWidget'), 'QRWidget'),
  scoreboard: lazyNamed(() => import('./ScoreboardWidget'), 'ScoreboardWidget'),
  expectations: lazyNamed(
    () => import('./ExpectationsWidget'),
    'ExpectationsWidget'
  ),
  poll: lazyNamed(() => import('./PollWidget'), 'PollWidget'),
  weather: lazyNamed(() => import('./WeatherWidget'), 'WeatherWidget'),
  schedule: lazyNamed(() => import('./ScheduleWidget'), 'ScheduleWidget'),
  calendar: lazyNamed(() => import('./CalendarWidget'), 'CalendarWidget'),
  lunchCount: lazyNamed(() => import('./LunchCount'), 'LunchCountWidget'),
  classes: lazy(() => import('./ClassesWidget')), // Default export
  instructionalRoutines: lazyNamed(
    () => import('./InstructionalRoutines/Widget'),
    'InstructionalRoutinesWidget'
  ),
  miniApp: lazyNamed(() => import('./MiniAppWidget'), 'MiniAppWidget'),
  materials: lazyNamed(() => import('./MaterialsWidget'), 'MaterialsWidget'),
  stickers: lazyNamed(
    () => import('./stickers/StickerBookWidget'),
    'StickerBookWidget'
  ),
  'seating-chart': lazyNamed(
    () => import('./SeatingChartWidget'),
    'SeatingChartWidget'
  ),
  catalyst: lazyNamed(() => import('./CatalystWidget'), 'CatalystWidget'),
  'catalyst-instruction': lazyNamed(
    () => import('./CatalystInstructionWidget'),
    'CatalystInstructionWidget'
  ),
  'catalyst-visual': lazyNamed(
    () => import('./CatalystVisualWidget'),
    'CatalystVisualWidget'
  ),
  smartNotebook: lazyNamed(
    () => import('./SmartNotebookWidget'),
    'SmartNotebookWidget'
  ),
  recessGear: lazyNamed(() => import('./RecessGearWidget'), 'RecessGearWidget'),
};

export const WIDGET_SETTINGS_COMPONENTS: Partial<
  Record<WidgetType, SettingsComponent>
> = {
  clock: lazyNamed(() => import('./ClockWidget'), 'ClockSettings'),
  text: lazyNamed(() => import('./TextWidget'), 'TextSettings'),
  checklist: lazyNamed(() => import('./ChecklistWidget'), 'ChecklistSettings'),
  random: lazyNamed(() => import('./random/RandomSettings'), 'RandomSettings'),
  dice: lazyNamed(() => import('./DiceWidget'), 'DiceSettings'),
  sound: lazyNamed(() => import('./SoundWidget'), 'SoundSettings'),
  embed: lazyNamed(() => import('./EmbedWidget'), 'EmbedSettings'),
  drawing: lazyNamed(() => import('./DrawingWidget'), 'DrawingSettings'),
  qr: lazyNamed(() => import('./QRWidget'), 'QRSettings'),
  scoreboard: lazyNamed(
    () => import('./ScoreboardSettings'),
    'ScoreboardSettings'
  ),
  webcam: lazyNamed(() => import('./WebcamWidget'), 'WebcamSettings'),
  calendar: lazyNamed(() => import('./CalendarWidget'), 'CalendarSettings'),
  weather: lazyNamed(() => import('./WeatherWidget'), 'WeatherSettings'),
  lunchCount: lazyNamed(() => import('./LunchCount'), 'LunchCountSettings'),
  poll: lazyNamed(() => import('./PollWidget'), 'PollSettings'),
  instructionalRoutines: lazyNamed(
    () => import('./InstructionalRoutines/Settings'),
    'InstructionalRoutinesSettings'
  ),
  materials: lazyNamed(() => import('./MaterialsWidget'), 'MaterialsSettings'),
  miniApp: MiniAppSettings,
  'time-tool': lazyNamed(
    () => import('./TimeTool/TimeToolWidget'),
    'TimeToolSettings'
  ),
  'seating-chart': lazyNamed(
    () => import('./SeatingChartSettings'),
    'SeatingChartSettings'
  ),
  catalyst: lazyNamed(() => import('./CatalystWidget'), 'CatalystSettings'),
  'catalyst-instruction': lazyNamed(
    () => import('./CatalystInstructionWidget'),
    'CatalystInstructionSettings'
  ),
  'catalyst-visual': lazyNamed(
    () => import('./CatalystVisualWidget'),
    'CatalystVisualSettings'
  ),
  smartNotebook: DefaultSettings,
  traffic: DefaultSettings,
  expectations: lazyNamed(
    () => import('./ExpectationsWidget'),
    'ExpectationsSettings'
  ),
  schedule: lazyNamed(() => import('./ScheduleWidget'), 'ScheduleSettings'),
  classes: DefaultSettings,
  recessGear: lazyNamed(
    () => import('./RecessGearWidget'),
    'RecessGearSettings'
  ),
};

export const DEFAULT_SCALING_CONFIG: ScalingConfig = {
  baseWidth: 300,
  baseHeight: 200,
  canSpread: true,
};

/**
 * Widget Scaling Configuration
 *
 * Controls how each widget adapts to its container size via ScalableWidget.
 *
 * Key properties:
 *  - baseWidth / baseHeight: Reference dimensions used by ScalableWidget's
 *    CSS-transform scaling. When skipScaling is true these serve only as
 *    default size hints.
 *  - canSpread: When true, the widget is allowed to fill available space
 *    (CSS transform capped at 1×). When false, the widget is always rendered
 *    at base dimensions and CSS-scaled.
 *  - skipScaling: When true, ScalableWidget is bypassed entirely. The widget
 *    receives the real container dimensions and a CSS `container-type: size`
 *    wrapper so it can use flex/grid/container-query layouts natively. This is
 *    the preferred mode for widgets with responsive CSS layouts.
 *
 * Widgets that KEEP CSS-transform scaling (skipScaling omitted / false):
 *  - drawing   – Canvas relies on fixed coordinate space; CSS-transform
 *                preserves pixel-perfect rendering.
 *  - seating-chart – Uses absolute-positioned seat nodes; CSS-transform keeps
 *                    coordinates consistent.
 *  - sticker   – Decorative overlay; fixed size, no DraggableWindow wrapper.
 */
export const WIDGET_SCALING_CONFIG: Record<WidgetType, ScalingConfig> = {
  clock: {
    baseWidth: 280,
    baseHeight: 140,
    canSpread: true,
    skipScaling: true,
    padding: 0,
  },
  'time-tool': {
    baseWidth: 420,
    baseHeight: 400,
    canSpread: true,
    skipScaling: true,
    padding: 0,
  },
  traffic: {
    baseWidth: 120,
    baseHeight: 320,
    canSpread: false,
    skipScaling: true,
    padding: 0,
  },
  text: {
    baseWidth: 300,
    baseHeight: 250,
    canSpread: true,
    skipScaling: true,
    padding: 0,
  },
  checklist: {
    baseWidth: 280,
    baseHeight: 300,
    canSpread: true,
    skipScaling: true,
    padding: 0,
  },
  random: {
    baseWidth: 300,
    baseHeight: 320,
    canSpread: true,
    skipScaling: true,
    padding: 4,
  },
  dice: {
    baseWidth: 240,
    baseHeight: 240,
    canSpread: false,
    skipScaling: true,
    padding: 0,
  },
  sound: {
    baseWidth: 300,
    baseHeight: 300,
    canSpread: true,
    skipScaling: true,
    padding: 0,
  },
  webcam: {
    baseWidth: 400,
    baseHeight: 300,
    canSpread: true,
    skipScaling: true,
    padding: 0,
  },
  embed: {
    baseWidth: 480,
    baseHeight: 350,
    canSpread: true,
    skipScaling: true,
    padding: 0,
  },
  drawing: {
    baseWidth: 400,
    baseHeight: 350,
    canSpread: true,
  },
  qr: {
    baseWidth: 200,
    baseHeight: 250,
    canSpread: false,
    skipScaling: true,
    padding: 0,
  },
  scoreboard: {
    baseWidth: 320,
    baseHeight: 200,
    canSpread: true,
    skipScaling: true,
    padding: 0,
  },
  expectations: {
    baseWidth: 320,
    baseHeight: 350,
    canSpread: true,
    skipScaling: true,
    padding: 0,
  },
  poll: {
    baseWidth: 300,
    baseHeight: 250,
    canSpread: true,
    skipScaling: true,
    padding: 0,
  },
  weather: {
    baseWidth: 250,
    baseHeight: 280,
    canSpread: true,
    skipScaling: true,
    padding: 0,
  },
  schedule: {
    baseWidth: 300,
    baseHeight: 350,
    canSpread: true,
    skipScaling: true,
    padding: 0,
  },
  calendar: {
    baseWidth: 300,
    baseHeight: 350,
    canSpread: true,
    skipScaling: true,
    padding: 0,
  },
  lunchCount: {
    baseWidth: 600,
    baseHeight: 400,
    canSpread: true,
    skipScaling: true,
  },
  classes: {
    baseWidth: 600,
    baseHeight: 500,
    canSpread: true,
    skipScaling: true,
  },
  instructionalRoutines: {
    baseWidth: 400,
    baseHeight: 480,
    canSpread: true,
    skipScaling: true,
  },
  miniApp: {
    baseWidth: 500,
    baseHeight: 600,
    canSpread: true,
    skipScaling: true,
  },
  materials: {
    baseWidth: 340,
    baseHeight: 340,
    canSpread: true,
    skipScaling: true,
    padding: 0,
  },
  stickers: {
    baseWidth: 600,
    baseHeight: 500,
    canSpread: true,
    skipScaling: true,
  },
  sticker: { baseWidth: 200, baseHeight: 200, canSpread: false },
  'seating-chart': {
    baseWidth: 600,
    baseHeight: 500,
    canSpread: true,
  },
  catalyst: {
    baseWidth: 450,
    baseHeight: 600,
    canSpread: true,
    skipScaling: true,
  },
  'catalyst-instruction': {
    baseWidth: 280,
    baseHeight: 350,
    canSpread: true,
    skipScaling: true,
  },
  'catalyst-visual': {
    baseWidth: 600,
    baseHeight: 400,
    canSpread: true,
    skipScaling: true,
  },
  smartNotebook: {
    baseWidth: 600,
    baseHeight: 500,
    canSpread: true,
    skipScaling: true,
  },
  recessGear: {
    baseWidth: 250,
    baseHeight: 280,
    canSpread: true,
    skipScaling: true,
  },
};
