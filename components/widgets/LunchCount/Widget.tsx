import React, { useState, useMemo, useCallback } from 'react';
import {
  DndContext,
  DragEndEvent,
  DragOverlay,
  DragStartEvent,
  useSensor,
  useSensors,
  defaultDropAnimationSideEffects,
  MouseSensor,
  TouchSensor,
  pointerWithin,
} from '@dnd-kit/core';
import { snapCenterToCursor } from '@dnd-kit/modifiers';
import { useDashboard } from '../../../context/useDashboard';
import { useAuth } from '../../../context/useAuth';
import {
  WidgetData,
  LunchCountConfig,
  LunchCountGlobalConfig,
} from '../../../types';
import { Button } from '../../common/Button';
import { RefreshCw, Undo2, CheckCircle2, Box, Users } from 'lucide-react';
import { SubmitReportModal } from './SubmitReportModal';
import { useNutrislice } from './useNutrislice';
import { DraggableStudent } from './components/DraggableStudent';
import { DroppableZone } from './components/DroppableZone';

import { WidgetLayout } from '../WidgetLayout';

/**
 * Format a grade value into the spreadsheet label used in column B.
 *   Schumann: K → K, 1 → GR1, 2 → GR2, MAC → MAC
 *   Intermediate: 3 → GR3, 4 → GR4, 5 → GR5
 */
function formatGradeLabel(grade: string): string {
  if (!grade) return '';
  if (grade === 'K' || grade === 'MAC') return grade;
  return `GR${grade}`;
}

/**
 * Format a display name to "F. Last" (first initial + last name).
 * e.g. "Jane Smith" → "J. Smith"
 */
function formatTeacherName(displayName: string): string {
  const parts = displayName.trim().split(/\s+/);
  if (parts.length >= 2 && parts[0].length > 0) {
    return `${parts[0][0]}. ${parts[parts.length - 1]}`;
  }
  return displayName;
}

/**
 * Format hour/minute strings into "H:MM" for display and submission.
 * Returns an empty string if hour is not set.
 */
function formatLunchTime(hour: string, minute: string): string {
  if (!hour) return '';
  return `${hour}:${(minute || '00').padStart(2, '0')}`;
}

/**
 * Build a Central Time (America/Chicago) timestamp string.
 * Falls back to the user's local time if the Intl API isn't available.
 */
function getCentralTimestamp(): string {
  try {
    return new Intl.DateTimeFormat('en-US', {
      timeZone: 'America/Chicago',
      year: 'numeric',
      month: '2-digit',
      day: '2-digit',
      hour: '2-digit',
      minute: '2-digit',
      second: '2-digit',
      hour12: true,
    }).format(new Date());
  } catch (error) {
    console.warn(
      '[LunchCountWidget] Failed to format timestamp in America/Chicago timezone; falling back to local time. Timestamps may not be in Central Time.',
      error
    );
    return new Date().toLocaleString();
  }
}

export const LunchCountWidget: React.FC<{ widget: WidgetData }> = ({
  widget,
}) => {
  const { updateWidget, addToast, rosters, activeRosterId } = useDashboard();
  const { user, featurePermissions } = useAuth();
  const config = widget.config as LunchCountConfig;
  const {
    cachedMenu = null,
    assignments = {},
    roster = [],
    rosterMode = 'class',
    schoolSite = 'schumann-elementary',
    lunchTimeHour = '',
    lunchTimeMinute = '',
    gradeLevel = '',
  } = config;

  // Resolve global lunch count settings from feature permissions
  const lunchGlobalConfig = useMemo((): LunchCountGlobalConfig => {
    const perm = featurePermissions.find((p) => p.widgetType === 'lunchCount');
    return (perm?.config ?? {}) as LunchCountGlobalConfig;
  }, [featurePermissions]);

  const { isSyncing, fetchNutrislice } = useNutrislice({
    widgetId: widget.id,
    config,
    updateWidget,
    addToast,
  });

  const [isModalOpen, setIsModalOpen] = useState(false);
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [activeId, setActiveId] = useState<string | null>(null);

  const sensors = useSensors(
    useSensor(MouseSensor, {
      activationConstraint: {
        distance: 10,
      },
    }),
    useSensor(TouchSensor, {
      activationConstraint: {
        delay: 250,
        tolerance: 5,
      },
    })
  );

  const activeRoster = useMemo((): string[] => {
    if (rosterMode === 'custom') return roster;
    const currentRoster =
      rosters.find((r) => r.id === activeRosterId) ?? rosters[0];
    return (
      currentRoster?.students.map((s) =>
        `${s.firstName} ${s.lastName}`.trim()
      ) ?? []
    );
  }, [rosterMode, roster, rosters, activeRosterId]);

  const stats = useMemo(() => {
    const total = activeRoster.length;
    const hotLunch = Object.values(assignments).filter(
      (a) => a === 'hot'
    ).length;
    const bentoBox = Object.values(assignments).filter(
      (a) => a === 'bento'
    ).length;
    const homeLunch = Object.values(assignments).filter(
      (a) => a === 'home'
    ).length;
    const remaining = total - (hotLunch + bentoBox + homeLunch);

    return { total, hotLunch, bentoBox, homeLunch, remaining };
  }, [activeRoster, assignments]);

  const updateAssignment = useCallback(
    (student: string, type: 'hot' | 'bento' | 'home' | null) => {
      const newAssignments = { ...assignments };
      if (type === null) {
        delete newAssignments[student];
      } else {
        newAssignments[student] = type;
      }
      updateWidget(widget.id, {
        config: { ...config, assignments: newAssignments },
      });
    },
    [widget.id, config, assignments, updateWidget]
  );

  const handleDragStart = (event: DragStartEvent) => {
    setActiveId(event.active.id as string);
  };

  const handleDragEnd = (event: DragEndEvent) => {
    const { active, over } = event;
    setActiveId(null);

    if (over) {
      const student = active.id as string;
      const zone = over.id as string;

      if (zone === 'hot' || zone === 'bento' || zone === 'home') {
        updateAssignment(student, zone);
      } else if (zone === 'unassigned') {
        updateAssignment(student, null);
      }
    }
  };

  const handleSubmitReport = async (notes: string, extraPizza?: number) => {
    const { submissionUrl, schumannSheetId, intermediateSheetId } =
      lunchGlobalConfig;

    if (!submissionUrl) {
      addToast(
        'No submission URL configured. Contact your administrator.',
        'error'
      );
      return;
    }

    const sheetId =
      schoolSite === 'orono-intermediate-school'
        ? intermediateSheetId
        : schumannSheetId;

    if (!sheetId) {
      addToast(
        'No Google Sheet ID configured for this school site. Contact your administrator.',
        'error'
      );
      return;
    }

    const teacherName = formatTeacherName(user?.displayName ?? 'Unknown Staff');
    const gradeLabel = formatGradeLabel(gradeLevel);
    const lunchTime = formatLunchTime(lunchTimeHour, lunchTimeMinute);

    const timestamp = getCentralTimestamp();
    // Column B: [Lunch Time] - [Grade] - [Teacher]
    const label = [lunchTime, gradeLabel, teacherName]
      .filter(Boolean)
      .join(' - ');

    // Columns C-F mapped for each school:
    //   Schumann:     C=hotLunch, D=bentoBox, E=(blank), F=notes
    //   Intermediate: C=hotLunch, D=bentoBox, E=extraPizza, F=notes
    const isIntermediate = schoolSite === 'orono-intermediate-school';

    setIsSubmitting(true);
    try {
      const body = new URLSearchParams({
        timestamp,
        label,
        hotLunch: String(stats.hotLunch),
        bentoBox: String(stats.bentoBox),
        extraPizza: isIntermediate ? String(extraPizza ?? 0) : '',
        notes,
        ...(sheetId ? { sheetId } : {}),
      });

      const response = await fetch(submissionUrl, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8',
        },
        body,
      });

      if (!response.ok) {
        throw new Error(`Submission failed with status ${response.status}`);
      }

      addToast('Lunch report submitted successfully!', 'success');
      setIsModalOpen(false);
    } catch (_err) {
      addToast(
        'Failed to submit report. Check your connection and try again.',
        'error'
      );
    } finally {
      setIsSubmitting(false);
    }
  };

  const dropAnimation = {
    sideEffects: defaultDropAnimationSideEffects({
      styles: {
        active: {
          opacity: '0.5',
        },
      },
    }),
  };

  const studentItemClass =
    'bg-white border-b-2 border-slate-200 rounded-xl font-black text-slate-700 shadow-sm hover:border-brand-blue-primary hover:-translate-y-0.5 transition-all active:scale-90';

  const studentItemStyle: React.CSSProperties = {
    fontSize: 'min(16px, 6cqmin)',
    padding: 'min(8px, 2cqmin) min(14px, 3.5cqmin)',
  };

  return (
    <DndContext
      sensors={sensors}
      collisionDetection={pointerWithin}
      onDragStart={handleDragStart}
      onDragEnd={handleDragEnd}
    >
      <WidgetLayout
        padding="p-0"
        header={
          <div
            className="flex justify-between items-center border-b border-slate-100 bg-slate-50/50"
            style={{
              padding: 'min(10px, 2cqmin)',
              gap: 'min(12px, 2.5cqmin)',
            }}
          >
            <div className="flex flex-col shrink-0">
              <h3
                style={{ fontSize: 'min(14px, 4.5cqmin)' }}
                className="font-black text-slate-700 uppercase tracking-widest"
              >
                Daily Lunch Count
              </h3>
              <p
                style={{ fontSize: 'min(12px, 3.5cqmin)' }}
                className="font-bold text-slate-500 uppercase tracking-tighter"
              >
                {new Date().toLocaleDateString('en-US', {
                  weekday: 'short',
                  month: 'short',
                  day: 'numeric',
                })}
              </p>
            </div>

            <Button
              onClick={() => setIsModalOpen(true)}
              disabled={stats.remaining > 0 || stats.total === 0}
              variant={
                stats.remaining === 0 && stats.total > 0
                  ? 'primary'
                  : 'secondary'
              }
              className="flex-1 rounded-xl font-black uppercase tracking-widest transition-all shadow-sm"
              style={{
                padding: 'min(6px, 1.5cqmin) min(16px, 4cqmin)',
                fontSize: 'min(12px, 4cqmin)',
                height: 'min(36px, 9cqmin)',
                maxWidth: 'min(280px, 50%)',
              }}
            >
              {stats.remaining === 0 && stats.total > 0 ? (
                <div
                  className="flex items-center justify-center"
                  style={{ gap: 'min(8px, 2cqmin)' }}
                >
                  <CheckCircle2
                    style={{
                      width: 'min(18px, 4.5cqmin)',
                      height: 'min(18px, 4.5cqmin)',
                    }}
                  />
                  Submit Report
                </div>
              ) : (
                <div
                  className="flex items-center justify-center opacity-60"
                  style={{ gap: 'min(8px, 2cqmin)' }}
                >
                  <Users
                    style={{
                      width: 'min(18px, 4.5cqmin)',
                      height: 'min(18px, 4.5cqmin)',
                    }}
                  />
                  Assign {stats.remaining} More Students
                </div>
              )}
            </Button>

            <div
              className="flex shrink-0"
              style={{ gap: 'min(6px, 1.5cqmin)' }}
            >
              <Button
                onClick={() => void fetchNutrislice()}
                variant="ghost"
                size="sm"
                className="rounded-xl bg-white border border-slate-200"
                style={{
                  padding: 'min(6px, 1.5cqmin)',
                  width: 'min(32px, 8cqmin)',
                  height: 'min(32px, 8cqmin)',
                }}
                disabled={isSyncing}
              >
                <RefreshCw
                  style={{
                    width: 'min(16px, 4.5cqmin)',
                    height: 'min(16px, 4.5cqmin)',
                  }}
                  className={isSyncing ? 'animate-spin' : ''}
                />
              </Button>
              <Button
                onClick={() =>
                  updateWidget(widget.id, {
                    config: { ...config, assignments: {} },
                  })
                }
                variant="ghost"
                size="sm"
                className="rounded-xl text-slate-400 hover:text-brand-red-primary bg-white border border-slate-200"
                style={{
                  padding: 'min(6px, 1.5cqmin)',
                  width: 'min(32px, 8cqmin)',
                  height: 'min(32px, 8cqmin)',
                }}
              >
                <Undo2
                  style={{
                    width: 'min(16px, 4.5cqmin)',
                    height: 'min(16px, 4.5cqmin)',
                  }}
                />
              </Button>
            </div>
          </div>
        }
        content={
          <div
            className="flex flex-col h-full w-full overflow-hidden animate-in fade-in duration-300"
            style={{ padding: 'min(10px, 2cqmin)', gap: 'min(10px, 2cqmin)' }}
          >
            {/* Top Grid: 3 Zones */}
            <div
              className="grid grid-cols-3 flex-1"
              style={{ gap: 'min(10px, 2cqmin)', minHeight: 0 }}
            >
              {/* Hot Lunch Drop Zone */}
              <DroppableZone
                id="hot"
                data-testid="hot-zone"
                className="bg-brand-red-lighter/10 border-2 border-dashed border-brand-red-lighter rounded-2xl flex flex-col transition-all group"
                style={{ padding: 'min(10px, 2cqmin)' }}
                activeClassName="border-solid border-brand-red-primary bg-brand-red-lighter/30 scale-[1.02]"
              >
                <div
                  className="flex justify-between items-start"
                  style={{ marginBottom: 'min(6px, 1.5cqmin)' }}
                >
                  <div className="flex flex-col">
                    <span
                      style={{ fontSize: 'min(11px, 4cqmin)' }}
                      className="font-black uppercase text-brand-red-primary tracking-tighter"
                    >
                      Hot Lunch
                    </span>
                    <span
                      style={{
                        fontSize: 'min(14px, 5cqmin)',
                        padding: 'min(3px, 0.8cqmin) min(8px, 2cqmin)',
                      }}
                      className="bg-brand-red-primary text-white rounded-full font-black w-max"
                    >
                      {stats.hotLunch}
                    </span>
                  </div>
                  <Box
                    style={{
                      width: 'min(14px, 4cqmin)',
                      height: 'min(14px, 4cqmin)',
                    }}
                    className="text-brand-red-primary opacity-40 group-hover:scale-110 transition-transform"
                  />
                </div>
                <div
                  style={{
                    fontSize: 'min(11px, 4cqmin)',
                    marginBottom: 'min(10px, 2cqmin)',
                  }}
                  className="font-bold text-brand-red-dark leading-tight line-clamp-2 italic opacity-60"
                >
                  {cachedMenu?.hotLunch ?? 'Loading menu...'}
                </div>
                <div
                  className="flex-1 flex flex-wrap content-start overflow-y-auto custom-scrollbar"
                  style={{
                    gap: 'min(6px, 1.5cqmin)',
                    paddingRight: 'min(4px, 1cqmin)',
                  }}
                >
                  {activeRoster
                    .filter((s) => assignments[s] === 'hot')
                    .map((student) => (
                      <DraggableStudent
                        key={student}
                        id={student}
                        name={student}
                        onClick={() => updateAssignment(student, null)}
                        className={studentItemClass}
                        style={studentItemStyle}
                      />
                    ))}
                </div>
              </DroppableZone>

              {/* Bento Box Drop Zone */}
              <DroppableZone
                id="bento"
                className="bg-emerald-50 border-2 border-dashed border-emerald-300 rounded-2xl flex flex-col transition-all group"
                style={{ padding: 'min(10px, 2cqmin)' }}
                activeClassName="border-solid border-emerald-500 bg-emerald-100/50 scale-[1.02]"
              >
                <div
                  className="flex justify-between items-start"
                  style={{ marginBottom: 'min(6px, 1.5cqmin)' }}
                >
                  <div className="flex flex-col">
                    <span
                      style={{ fontSize: 'min(11px, 4cqmin)' }}
                      className="font-black uppercase text-emerald-600 tracking-tighter"
                    >
                      Bento Box
                    </span>
                    <span
                      style={{
                        fontSize: 'min(14px, 5cqmin)',
                        padding: 'min(3px, 0.8cqmin) min(8px, 2cqmin)',
                      }}
                      className="bg-emerald-500 text-white rounded-full font-black w-max"
                    >
                      {stats.bentoBox}
                    </span>
                  </div>
                  <Box
                    style={{
                      width: 'min(14px, 4cqmin)',
                      height: 'min(14px, 4cqmin)',
                    }}
                    className="text-emerald-400 group-hover:scale-110 transition-transform"
                  />
                </div>
                <div
                  style={{
                    fontSize: 'min(11px, 4cqmin)',
                    marginBottom: 'min(10px, 2cqmin)',
                  }}
                  className="font-bold text-emerald-800 leading-tight line-clamp-2 italic opacity-60"
                >
                  {cachedMenu?.bentoBox ?? 'Loading menu...'}
                </div>
                <div
                  className="flex-1 flex flex-wrap content-start overflow-y-auto custom-scrollbar"
                  style={{
                    gap: 'min(6px, 1.5cqmin)',
                    paddingRight: 'min(4px, 1cqmin)',
                  }}
                >
                  {activeRoster
                    .filter((s) => assignments[s] === 'bento')
                    .map((student) => (
                      <DraggableStudent
                        key={student}
                        id={student}
                        name={student}
                        onClick={() => updateAssignment(student, null)}
                        className={studentItemClass}
                        style={studentItemStyle}
                      />
                    ))}
                </div>
              </DroppableZone>

              {/* Home Lunch Drop Zone */}
              <DroppableZone
                id="home"
                className="bg-brand-blue-lighter/20 border-2 border-dashed border-brand-blue-lighter rounded-2xl flex flex-col transition-all group"
                style={{ padding: 'min(10px, 2cqmin)' }}
                activeClassName="border-solid border-brand-blue-primary bg-brand-blue-lighter/40 scale-[1.02]"
              >
                <div
                  className="flex justify-between items-start"
                  style={{ marginBottom: 'min(6px, 1.5cqmin)' }}
                >
                  <div className="flex flex-col">
                    <span
                      style={{ fontSize: 'min(11px, 4cqmin)' }}
                      className="font-black uppercase text-brand-blue-primary tracking-tighter"
                    >
                      Home / Other
                    </span>
                    <span
                      style={{
                        fontSize: 'min(14px, 5cqmin)',
                        padding: 'min(3px, 0.8cqmin) min(8px, 2cqmin)',
                      }}
                      className="bg-brand-blue-primary text-white rounded-full font-black w-max"
                    >
                      {stats.homeLunch}
                    </span>
                  </div>
                  <Box
                    style={{
                      width: 'min(14px, 4cqmin)',
                      height: 'min(14px, 4cqmin)',
                    }}
                    className="text-brand-blue-primary opacity-40 group-hover:scale-110 transition-transform"
                  />
                </div>
                <div
                  style={{
                    fontSize: 'min(11px, 4cqmin)',
                    marginBottom: 'min(10px, 2cqmin)',
                  }}
                  className="font-bold text-brand-blue-dark leading-tight italic opacity-60"
                >
                  Field Trips / Absent
                </div>
                <div
                  className="flex-1 flex flex-wrap content-start overflow-y-auto custom-scrollbar"
                  style={{
                    gap: 'min(6px, 1.5cqmin)',
                    paddingRight: 'min(4px, 1cqmin)',
                  }}
                >
                  {activeRoster
                    .filter((s) => assignments[s] === 'home')
                    .map((student) => (
                      <DraggableStudent
                        key={student}
                        id={student}
                        name={student}
                        onClick={() => updateAssignment(student, null)}
                        className={studentItemClass}
                        style={studentItemStyle}
                      />
                    ))}
                </div>
              </DroppableZone>
            </div>

            {/* Bottom Area: All Unassigned Students */}
            <div className="flex-1 flex flex-col min-h-0">
              <DroppableZone
                id="unassigned"
                className="flex-1 bg-slate-50 border-2 border-dashed border-slate-200 rounded-3xl overflow-y-auto custom-scrollbar shadow-inner"
                style={{ padding: 'min(12px, 2.5cqmin)' }}
                activeClassName="bg-slate-100 border-brand-blue-primary ring-4 ring-brand-blue-lighter/20"
              >
                <div className="flex flex-col items-center h-full">
                  <div
                    className="flex items-center"
                    style={{
                      gap: 'min(6px, 1.5cqmin)',
                      marginBottom: 'min(12px, 2.5cqmin)',
                    }}
                  >
                    <Users
                      style={{
                        width: 'min(16px, 4.5cqmin)',
                        height: 'min(16px, 4.5cqmin)',
                      }}
                      className="text-slate-300"
                    />
                    <span
                      style={{ fontSize: 'min(12px, 4.5cqmin)' }}
                      className="font-black uppercase text-slate-400 tracking-widest"
                    >
                      Unassigned ({stats.remaining})
                    </span>
                  </div>

                  <div
                    className="flex flex-wrap justify-center w-full"
                    style={{ gap: 'min(6px, 1.5cqmin)' }}
                  >
                    {activeRoster
                      .filter((s) => !assignments[s])
                      .map((student) => (
                        <DraggableStudent
                          key={student}
                          id={student}
                          name={student}
                          className={studentItemClass}
                          style={studentItemStyle}
                        />
                      ))}
                    {stats.remaining === 0 && stats.total > 0 && (
                      <div
                        className="flex flex-col items-center justify-center opacity-30 grayscale animate-in zoom-in-95 duration-500"
                        style={{
                          paddingTop: 'min(32px, 10cqmin)',
                          paddingBottom: 'min(32px, 10cqmin)',
                        }}
                      >
                        <CheckCircle2
                          style={{
                            width: 'min(48px, 12cqmin)',
                            height: 'min(48px, 12cqmin)',
                            marginBottom: 'min(10px, 2.5cqmin)',
                          }}
                          className="text-brand-blue-primary"
                        />
                        <span
                          style={{ fontSize: 'min(14px, 5cqmin)' }}
                          className="font-black uppercase tracking-[0.2em]"
                        >
                          Roster Complete
                        </span>
                      </div>
                    )}
                  </div>
                </div>
              </DroppableZone>
            </div>
          </div>
        }
      />

      {/* Modal */}
      <SubmitReportModal
        isOpen={isModalOpen}
        onClose={() => setIsModalOpen(false)}
        onSubmit={handleSubmitReport}
        data={{
          date: new Date().toLocaleDateString(),
          staffName: formatTeacherName(user?.displayName ?? 'Unknown Staff'),
          hotLunch: stats.hotLunch,
          bentoBox: stats.bentoBox,
          hotLunchName: cachedMenu?.hotLunch ?? 'Hot Lunch',
          bentoBoxName: cachedMenu?.bentoBox ?? 'Bento Box',
          schoolSite,
          lunchTime: formatLunchTime(lunchTimeHour, lunchTimeMinute),
          gradeLabel: formatGradeLabel(gradeLevel),
        }}
        isSubmitting={isSubmitting}
      />
      <DragOverlay
        dropAnimation={dropAnimation}
        modifiers={[snapCenterToCursor]}
      >
        {activeId ? (
          <div
            data-no-drag="true"
            className="bg-brand-blue-primary border-b-4 border-brand-blue-dark rounded-2xl font-black text-white shadow-2xl scale-110 opacity-95 cursor-grabbing pointer-events-none"
            style={{
              padding: 'min(8px, 2cqmin) min(16px, 4cqmin)',
              fontSize: 'min(14px, 6cqmin)',
            }}
          >
            {activeId}
          </div>
        ) : null}
      </DragOverlay>
    </DndContext>
  );
};
